<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Orden - Servitel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Configuración de colores corporativos -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3e78b2',    // Azul Claro
                        secondary: '#004ba8',  // Azul Oscuro
                        accent: '#deefb7',     // Verde Claro
                        neutral: '#bcabae',    // Grisáceo
                        dark: '#0f0f0f',       // Negro
                        success: '#17c964',    // Verde éxito
                        warning: '#f5a524',    // Naranja alerta
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .form-input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border-radius: 0.375rem;
            border: 2px solid #e5e7eb;
            background-color: white;
            transition: all 0.2s;
            outline: none;
            font-size: 0.875rem;
        }
        .form-input:focus {
            border-color: #3e78b2;
            box-shadow: 0 0 0 1px #3e78b2;
        }
        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        /* Animación suave para filas de la tabla */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-dark bg-gray-50 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 border-b border-gray-200 sticky top-0 z-10">
        <div class="flex items-center gap-3">
            <a href="#" onclick="history.back()" class="text-gray-500 hover:text-primary transition-colors"><i class="fa-solid fa-arrow-left"></i></a>
            <div>
                <h1 class="text-xl font-bold text-primary flex items-center gap-2">
                    Editar Orden <span class="text-gray-400 font-normal">#<span id="headerOrderId">Cargando...</span></span>
                </h1>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 border border-blue-200" id="headerStatusBadge">CARGANDO...</span>
            <img src="https://ui-avatars.com/api/?name=Admin&background=004ba8&color=fff" class="w-8 h-8 rounded-full">
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 p-6 max-w-7xl mx-auto w-full">
        
        <form id="editOrderForm" onsubmit="guardarCambios(event)">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- COLUMNA IZQUIERDA (2/3) -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- 1. DATOS DEL ABONADO (Editable) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50/50 border-b border-gray-100 px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-user text-secondary"></i>
                                <h3 class="font-semibold text-secondary">Datos del Abonado</h3>
                            </div>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">N. Abonado</label>
                                <input type="text" id="subscriberNumber" name="subscriberNumber" class="form-input bg-gray-50 text-gray-500 cursor-not-allowed" readonly>
                            </div>
                            <div>
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" id="subscriberName" name="subscriberName" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Teléfonos</label>
                                <input type="text" id="phones" name="phones" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Correo Electrónico</label>
                                <input type="email" id="email" name="email" class="form-input">
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label">Dirección</label>
                                <textarea id="address" name="address" class="form-input resize-y min-h-[60px]"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 2. DATOS TÉCNICOS -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50/50 border-b border-gray-100 px-6 py-4 flex items-center gap-2">
                            <i class="fa-solid fa-microchip text-secondary"></i>
                            <h3 class="font-semibold text-secondary">Datos Técnicos</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Nodo / Ubicación</label>
                                <input type="text" id="node" name="node" class="form-input">
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label">Servicios / Reporte</label>
                                <textarea id="servicesToInstall" name="servicesToInstall" class="form-input resize-y min-h-[60px]"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 3. MATERIALES UTILIZADOS (NUEVA SECCIÓN) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50/50 border-b border-gray-100 px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-tools text-secondary"></i>
                                <h3 class="font-semibold text-secondary">Materiales Utilizados</h3>
                            </div>
                            <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">Control de Stock</span>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- Barra para agregar material -->
                            <div class="flex flex-col sm:flex-row gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200 items-end">
                                <div class="flex-1 w-full">
                                    <label class="form-label text-xs">Material / Equipo</label>
                                    <select id="materialSelect" class="form-input text-sm">
                                        <option value="">-- Seleccionar Material --</option>
                                        <option value="CABLE UTP CAT6">Cable UTP Cat6 (mts)</option>
                                        <option value="CONECTOR RJ45">Conector RJ45 (unidad)</option>
                                        <option value="ONT HUAWEI">ONT Huawei (equipo)</option>
                                        <option value="ROUTER TP-LINK">Router TP-Link (equipo)</option>
                                        <option value="PRECINTO PLASTICO">Precinto Plástico (unidad)</option>
                                    </select>
                                </div>
                                <div class="w-24">
                                    <label class="form-label text-xs">Cantidad</label>
                                    <input type="number" id="materialQuantity" class="form-input text-sm" min="1" value="1">
                                </div>
                                <button type="button" onclick="agregarMaterial()" class="bg-secondary hover:bg-primary text-white px-4 py-2.5 rounded-md font-medium text-sm transition-colors flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Agregar
                                </button>
                            </div>

                            <!-- Tabla de materiales -->
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-gray-500 font-semibold border-b border-gray-200">
                                        <tr>
                                            <th class="px-4 py-3">Material</th>
                                            <th class="px-4 py-3 w-24 text-center">Cant.</th>
                                            <th class="px-4 py-3 w-16 text-right"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="materialsTableBody" class="divide-y divide-gray-100">
                                        <!-- Las filas se agregan dinámicamente aquí -->
                                        <tr id="emptyRow">
                                            <td colspan="3" class="px-4 py-8 text-center text-gray-400 italic">
                                                No se han registrado materiales aún.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- COLUMNA DERECHA (1/3) - GESTIÓN Y ESTADO -->
                <div class="space-y-6">
                    
                    <!-- TARJETA DE GESTIÓN -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-fit sticky top-24">
                        <div class="bg-accent/30 border-b border-accent px-6 py-4">
                            <h3 class="font-semibold text-secondary">Estado y Asignación</h3>
                        </div>
                        <div class="p-6 space-y-6">
                            
                            <!-- Estado de la Orden -->
                            <div>
                                <label class="form-label">Estado Actual</label>
                                <div class="relative">
                                    <select id="statusSelect" name="status" onchange="actualizarVisualEstado()" class="form-input pl-10 appearance-none font-semibold cursor-pointer text-gray-700">
                                        <option value="pending">Pendiente</option>
                                        <option value="assigned">Asignada</option>
                                        <option value="in_progress">En Progreso</option>
                                        <option value="completed">Completada</option>
                                        <option value="cancelled">Cancelada</option>
                                    </select>
                                    <!-- Icono dinámico según estado -->
                                    <div class="absolute inset-y-0 left-0 flex items-center px-3 pointer-events-none" id="statusIconWrapper">
                                        <i class="fa-solid fa-circle text-yellow-500"></i>
                                    </div>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-2" id="statusDescription">
                                    La orden está en espera de ser atendida.
                                </p>
                            </div>

                            <hr class="border-gray-100">

                            <!-- Asignación de Técnico -->
                            <div>
                                <label class="form-label">Técnico Asignado</label>
                                <div class="relative">
                                    <i class="fa-solid fa-user-gear absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <select id="technicianSelect" name="assignedTo" class="form-input pl-10 appearance-none cursor-pointer">
                                        <option value="">-- Sin Asignar --</option>
                                        <option value="tech_1">Juan Perez (Técnico)</option>
                                        <option value="tech_2">Maria Rodriguez (Ayudante)</option>
                                        <option value="tech_3">Carlos Martinez (Instalador)</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Tipo de Orden -->
                            <div>
                                <label class="form-label">Tipo de Orden</label>
                                <select id="typeSelect" name="type" class="form-input appearance-none">
                                    <option value="instalacion">Instalación</option>
                                    <option value="averia">Avería</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>

                            <!-- Reporte de Cierre (Visible solo si completada) -->
                            <div id="closureDetails" class="hidden animate-pulse bg-green-50 p-3 rounded border border-green-100">
                                <label class="form-label text-green-800">Detalles de Cierre</label>
                                <textarea name="reportDetails" class="form-input border-green-200 text-sm" placeholder="Comentarios finales del técnico..."></textarea>
                            </div>

                            <!-- Botones -->
                            <div class="pt-4 flex flex-col gap-3">
                                <button type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2 transform active:scale-[0.98]">
                                    <i class="fa-solid fa-save"></i> Guardar Cambios
                                </button>
                                <button type="button" onclick="history.back()" class="w-full bg-white hover:bg-gray-50 text-gray-600 font-medium py-3 px-4 rounded-lg border border-gray-200 hover:border-gray-300 transition-all">
                                    Cancelar
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </form>

    </main>

    <!-- LOGICA JAVASCRIPT -->
    <script>
        // 1. Simulación de carga de datos (Mock Data)
        document.addEventListener('DOMContentLoaded', () => {
            // Datos falsos que vendrían de MongoDB
            const mockOrder = {
                subscriberNumber: "368063",
                subscriberName: "DANIEL GEU HERNANDEZ CHACON",
                address: "MUNICIPIO CÁRDENAS, Sector Las Lomas, Calle 3, Casa 45-B",
                phones: "04247617337, 04141234567",
                email: "hernandeztrillosdaniel@gmail.com",
                node: "SCRVEG20112A-GPON TAR29A",
                servicesToInstall: "Internet FibraNet500, Telefonía IP",
                status: "assigned", // Estado inicial
                assignedTo: "tech_1", // Juan Perez
                type: "instalacion",
                materialsUsed: [
                    { name: "CABLE UTP CAT6", quantity: 25 },
                    { name: "CONECTOR RJ45", quantity: 2 }
                ]
            };

            // Rellenar campos
            document.getElementById('headerOrderId').innerText = mockOrder.subscriberNumber;
            document.getElementById('subscriberNumber').value = mockOrder.subscriberNumber;
            document.getElementById('subscriberName').value = mockOrder.subscriberName;
            document.getElementById('phones').value = mockOrder.phones;
            document.getElementById('email').value = mockOrder.email;
            document.getElementById('address').value = mockOrder.address;
            document.getElementById('node').value = mockOrder.node;
            document.getElementById('servicesToInstall').value = mockOrder.servicesToInstall;
            
            // Selects
            document.getElementById('statusSelect').value = mockOrder.status;
            document.getElementById('technicianSelect').value = mockOrder.assignedTo;
            document.getElementById('typeSelect').value = mockOrder.type;

            // Cargar materiales iniciales
            mockOrder.materialsUsed.forEach(mat => agregarFilaMaterial(mat.name, mat.quantity));

            // Actualizar visuales
            actualizarVisualEstado();
        });

        // 2. Funciones para Materiales
        function agregarMaterial() {
            const select = document.getElementById('materialSelect');
            const qtyInput = document.getElementById('materialQuantity');
            const material = select.value;
            const quantity = qtyInput.value;

            if (!material) {
                alert("Por favor selecciona un material.");
                return;
            }

            agregarFilaMaterial(material, quantity);
            
            // Reset inputs
            select.value = "";
            qtyInput.value = "1";
        }

        function agregarFilaMaterial(materialName, quantity) {
            const tbody = document.getElementById('materialsTableBody');
            const emptyRow = document.getElementById('emptyRow');
            if (emptyRow) emptyRow.remove();

            const row = document.createElement('tr');
            row.className = "fade-in bg-white border-b border-gray-50 hover:bg-gray-50 transition-colors";
            row.innerHTML = `
                <td class="px-4 py-3 font-medium text-gray-700">${materialName}</td>
                <td class="px-4 py-3 text-center">
                    <input type="number" value="${quantity}" min="1" class="w-16 text-center border rounded p-1 text-sm focus:border-primary outline-none">
                </td>
                <td class="px-4 py-3 text-right">
                    <button type="button" onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }

        // 3. Lógica Visual de Estado
        function actualizarVisualEstado() {
            const status = document.getElementById('statusSelect').value;
            const iconWrapper = document.getElementById('statusIconWrapper');
            const desc = document.getElementById('statusDescription');
            const badge = document.getElementById('headerStatusBadge');
            const closureBox = document.getElementById('closureDetails');

            let colorClass = "text-gray-500";
            let badgeClass = "bg-gray-100 text-gray-800 border-gray-200";
            let description = "";

            // Ocultar detalles de cierre por defecto
            closureBox.classList.add('hidden');
            closureBox.classList.remove('block');

            switch(status) {
                case 'pending':
                    colorClass = "text-yellow-500";
                    badgeClass = "bg-yellow-100 text-yellow-800 border-yellow-200";
                    description = "Orden creada, pendiente de asignación.";
                    break;
                case 'assigned':
                    colorClass = "text-blue-500";
                    badgeClass = "bg-blue-100 text-blue-800 border-blue-200";
                    description = "Técnico notificado. En espera de inicio.";
                    break;
                case 'in_progress':
                    colorClass = "text-purple-500";
                    badgeClass = "bg-purple-100 text-purple-800 border-purple-200";
                    description = "El técnico está trabajando en el sitio.";
                    break;
                case 'completed':
                    colorClass = "text-green-500";
                    badgeClass = "bg-green-100 text-green-800 border-green-200";
                    description = "Trabajo finalizado y reportado.";
                    closureBox.classList.remove('hidden');
                    closureBox.classList.add('block');
                    break;
                case 'cancelled':
                    colorClass = "text-red-500";
                    badgeClass = "bg-red-100 text-red-800 border-red-200";
                    description = "Orden cancelada por el operador.";
                    break;
            }

            // Actualizar icono del select
            iconWrapper.innerHTML = `<i class="fa-solid fa-circle ${colorClass}"></i>`;
            desc.innerText = description;
            
            // Actualizar Badge del Header
            badge.className = `px-3 py-1 rounded-full text-xs font-bold border ${badgeClass} uppercase`;
            badge.innerText = status.replace('_', ' ');
        }

        // 4. Guardar Cambios
        function guardarCambios(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            
            // Recopilar materiales
            const rows = document.querySelectorAll('#materialsTableBody tr');
            const materiales = [];
            rows.forEach(row => {
                if(row.id === 'emptyRow') return;
                materiales.push({
                    name: row.cells[0].innerText,
                    qty: row.querySelector('input').value
                });
            });

            console.log("Guardando Orden...", { 
                status: document.getElementById('statusSelect').value,
                tech: document.getElementById('technicianSelect').value,
                materiales: materiales 
            });

            // UI Loading
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Guardando...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            setTimeout(() => {
                alert("¡Orden actualizada correctamente!");
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }, 1000);
        }
    </script>
</body>
</html>